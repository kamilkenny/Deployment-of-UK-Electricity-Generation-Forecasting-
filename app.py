# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/19G_xR-Kvz8hHcMeFwQv4FuTn9wjlQKGC
"""

import streamlit as st
import pandas as pd
import joblib
import datetime
import numpy as np
import matplotlib.pyplot as plt
import os
from PIL import Image
from tensorflow.keras.models import load_model

# 1. Page Configuration
st.set_page_config(
    page_title="UK Grid Analytics | Kamil Kehinde",
    page_icon="‚ö°",
    layout="wide"
)

# --- üé® ADVANCED CUSTOM CSS ---
st.markdown("""
    <style>
    /* Light Blue Background */
    .stApp {
        background-color: #e6f3ff;
    }

    /* Centering the Lead Modeller Image */
    .main-img-container {
        display: flex;
        justify-content: center;
        margin-top: 10px;
        margin-bottom: 5px;
    }

    /* Styling Metric Cards */
    [data-testid="stMetricValue"] {
        font-size: 32px;
        color: #004080;
        font-weight: bold;
    }

    /* Justified Text for Introduction */
    .justified-text {
        text-align: justify;
    }
    </style>
    """, unsafe_allow_html=True)

# 2. Sidebar - Branding & Identification
with st.sidebar:
    st.header("üë§ Lead Modeller")
    st.write("**Kamil Kehinde**")
    st.divider()
    st.info("üí° **Project Goal:** A.I. Forecasting-Modelling with Great Britain‚Äôs System Operator (NESO) Generation Data Portal.")
    st.caption("Developed as part of a high-resolution Energy Case Study.")

# 3. Central Image & Header
st.markdown('<div class="main-img-container">', unsafe_allow_html=True)
try:
    img = Image.open("kamil_profile.jpg")
    st.image(img, width=350, caption="Kamil Kehinde - Lead Modeller")
except:
    st.warning("‚ö†Ô∏è Image 'kamil_profile.jpg' not found in repository.")
st.markdown('</div>', unsafe_allow_html=True)

# Main Title & Executive Summary
st.title("‚ö° UK Electricity Generation Dashboard")
st.markdown("""
<div class="justified-text">
The UK electricity system has undergone a significant transformation due to increasing <b>renewable penetration</b>,
declining <b>coal usage</b>, and evolving <b>demand patterns</b>. Accurate short-term electricity generation
forecasting is critical for:
</div>
""", unsafe_allow_html=True)

# Organizing pillars
c1, c2, c3 = st.columns(3)
with c1:
    st.markdown("üéØ **Grid Balancing**")
    st.caption("Ensuring supply matches demand in real-time to prevent blackouts.")
with c2:
    st.markdown("üå± **Renewable Integration**")
    st.caption("Optimizing the use of intermittent sources like wind and solar.")
with c3:
    st.markdown("üìâ **Cost Reduction**")
    st.caption("Reducing the need for expensive, high-carbon reserve power plants.")

# 4. Model & Assets Loading
@st.cache_resource
def load_assets():
    base_path = os.path.dirname(__file__) if "__file__" in locals() else os.getcwd()
    model_path = os.path.join(base_path, 'uni_lstm_model.h5')
    scaler_path = os.path.join(base_path, 'uni_scaler.pkl')

    nn_model = load_model(model_path)
    scaler = joblib.load(scaler_path)
    return nn_model, scaler

@st.cache_data
def load_seed_data():
    # Using your repository raw link
    url = "https://raw.githubusercontent.com/kamilkenny/Deployment-of-UK-Electricity-Generation-Forecasting-/main/load_hindcast_data.csv"
    try:
        df_h = pd.read_csv(url)
        df_h['DATETIME'] = pd.to_datetime(df_h['DATETIME'])
        return df_h.sort_values('DATETIME')
    except:
        return pd.DataFrame()

try:
    model, scaler = load_assets()
    df_history = load_seed_data()
except Exception as e:
    st.error(f"üö® System Error: {e}")

# 5. User Input Configuration
st.divider()
st.subheader("üìÖ Configure Prediction Horizon")

col_input, _ = st.columns([1, 1])
with col_input:
    start_init = datetime.date(2026, 2, 17)
    end_init = start_init + datetime.timedelta(days=3)
    selected_range = st.date_input("Select Prediction Range", value=(start_init, end_init))

predict_btn = st.button("üöÄ Run LSTM Forecast Analysis", type="primary", use_container_width=True)

# 6. Recursive Forecast Logic
if predict_btn:
    if isinstance(selected_range, tuple) and len(selected_range) == 2:
        start_d, end_d = selected_range
        idx = pd.date_range(
            start=datetime.datetime.combine(start_d, datetime.time(0, 0)),
            end=datetime.datetime.combine(end_d, datetime.time(23, 30)),
            freq='30min'
        )

        # Build the initial seed from your history (Last 24 steps)
        if not df_history.empty:
            seed_values = df_history['GENERATION'].values[-24:].reshape(-1, 1)
            current_batch = scaler.transform(seed_values).reshape(1, 24, 1)
        else:
            current_batch = np.full((1, 24, 1), 0.5)

        forecast_scaled = []

        # Progress bar for visual feedback
        progress_bar = st.progress(0)
        for i in range(len(idx)):
            pred = model.predict(current_batch, verbose=0)
            forecast_scaled.append(pred[0, 0])

            # Slide the window
            pred_reshaped = pred.reshape(1, 1, 1)
            current_batch = np.append(current_batch[:, 1:, :], pred_reshaped, axis=1)
            progress_bar.progress((i + 1) / len(idx))

        # Final conversion
        mw_preds = scaler.inverse_transform(np.array(forecast_scaled).reshape(-1, 1))
        df_pred = pd.DataFrame({'Forecast_MW': mw_preds.flatten()}, index=idx)

        # KPI Metrics
        st.divider()
        st.markdown("#### üìà Key Performance Indicators (KPIs)")
        k1, k2, k3 = st.columns(3)
        k1.metric("Average Load", f"{df_pred['Forecast_MW'].mean():,.0f} MW")
        k2.metric("Predicted Peak", f"{df_pred['Forecast_MW'].max():,.0f} MW")
        k3.metric("Total Volume", f"{(df_pred['Forecast_MW'].sum() * 0.5) / 1000:,.2f} GWh")

        # Trend Chart
        st.divider()
        st.markdown(f"#### üìä Generation Trend: {start_d} to {end_d}")
        st.line_chart(df_pred['Forecast_MW'], color="#004080")

        # Export result
        st.download_button("üì• Download Analysis Results (CSV)", df_pred.to_csv(), "forecast_results.csv", "text/csv")
    else:
        st.error("‚ö†Ô∏è Please select a valid start and end date.")

st.divider()
st.caption("¬© 2026 Energy Analytics Portfolio | Kamil Kehinde | Data Source: NESO Data Portal")