# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1YshZ0vTLJq1lwolpQ2IM26F1TUqQ607-
"""

import streamlit as st
import pandas as pd
import joblib
import datetime
import numpy as np
from PIL import Image

# 1. Page Configuration
st.set_page_config(
    page_title="UK Grid Analytics | Kamil Kehinde",
    page_icon="‚ö°",
    layout="wide"
)

# --- üé® ADVANCED CUSTOM CSS ---
st.markdown("""
    <style>
    /* Light Blue Background */
    .stApp {
        background-color: #e6f3ff;
    }

    /* Centering the Lead Modeller Image */
    .main-img-container {
        display: flex;
        justify-content: center;
        margin-top: 10px;
        margin-bottom: 5px;
    }

    /* Styling Metric Cards */
    [data-testid="stMetricValue"] {
        font-size: 32px;
        color: #004080;
        font-weight: bold;
    }

    /* Justified Text for Introduction */
    .justified-text {
        text-align: justify;
    }
    </style>
    """, unsafe_allow_html=True)

# 2. Sidebar - Branding & Identification
with st.sidebar:
    st.header("üë§ Lead Modeller")
    st.write("**Kamil Kehinde**")
    st.divider()
    st.info("üí° **Project Goal:** A.I. Forecasting-Modelling with Great Britain‚Äôs System Operator (NESO) Generation Data Portal.")
    st.caption("Developed as part of a high-resolution Energy Case Study.")

# 3. Central Image & Header
st.markdown('<div class="main-img-container">', unsafe_allow_html=True)
try:
    img = Image.open("kamil_profile.jpg")
    st.image(img, width=350, caption="Kamil Kehinde - Lead Modeller")
except:
    st.warning("‚ö†Ô∏è Image 'kamil_profile.jpg' not found in repository.")
st.markdown('</div>', unsafe_allow_html=True)

# Main Title & Executive Summary
st.title("‚ö° UK Electricity Generation Dashboard")
st.markdown("""
<div class="justified-text">
The UK electricity system has undergone a significant transformation due to increasing <b>renewable penetration</b>,
declining <b>coal usage</b>, and evolving <b>demand patterns</b>. Accurate short-term electricity generation
forecasting is critical for:
</div>
""", unsafe_allow_html=True)

# Organizing your addition into clear pillars
c1, c2, c3 = st.columns(3)
with c1:
    st.markdown("üéØ **Grid Balancing**")
    st.caption("Ensuring supply matches demand in real-time to prevent blackouts.")
with c2:
    st.markdown("üå± **Renewable Integration**")
    st.caption("Optimizing the use of intermittent sources like wind and solar.")
with c3:
    st.markdown("üìâ **Cost Reduction**")
    st.caption("Reducing the need for expensive, high-carbon reserve power plants.")

# 4. Model Loading
@st.cache_resource
def load_model():
    return joblib.load('gb_gen_time_only.pkl')

model = load_model()

# 5. User Input Configuration
st.divider()
st.subheader("üìÖ Configure Prediction Horizon")

col_input, col_spacer = st.columns([1, 1])
with col_input:
    # Default range setup
    start_init = datetime.date(2026, 2, 16)
    end_init = start_init + datetime.timedelta(days=3)

    selected_range = st.date_input(
        "Select Start and End Dates",
        value=(start_init, end_init),
        help="The model will generate a 30-minute interval forecast for this period."
    )

# Prediction Button
predict_btn = st.button("üöÄ Run Forecast Analysis", type="primary", use_container_width=True)

# 6. Forecast Execution Logic
if predict_btn:
    if isinstance(selected_range, tuple) and len(selected_range) == 2:
        start_d, end_d = selected_range

        # Build Time Index
        idx = pd.date_range(
            start=datetime.datetime.combine(start_d, datetime.time(0, 0)),
            end=datetime.datetime.combine(end_d, datetime.time(23, 30)),
            freq='30T'
        )

        # Build Features for XGBoost
        df_pred = pd.DataFrame(index=idx)
        df_pred['hour'] = df_pred.index.hour
        df_pred['dayofweek'] = df_pred.index.dayofweek
        df_pred['month'] = df_pred.index.month
        df_pred['year'] = df_pred.index.year

        # Generate Predictions
        df_pred['Forecast_MW'] = model.predict(df_pred)

        # Calculations
        avg_mw = df_pred['Forecast_MW'].mean()
        peak_mw = df_pred['Forecast_MW'].max()
        total_gwh = (df_pred['Forecast_MW'].sum() * 0.5) / 1000

        # KPI Results
        st.divider()
        st.markdown("#### üìà Key Performance Indicators (KPIs)")
        k1, k2, k3 = st.columns(3)
        k1.metric("Average Load", f"{avg_mw:,.0f} MW")
        k2.metric("Predicted Peak", f"{peak_mw:,.0f} MW")
        k3.metric("Total Energy Volume", f"{total_gwh:,.2f} GWh")

        # Visual Trend
        st.divider()
        st.markdown(f"#### üìä Generation Trend: {start_d} to {end_d}")
        st.line_chart(df_pred['Forecast_MW'], color="#007acc")

        # Data Export
        st.download_button(
            "üì• Download Analysis Results (CSV)",
            data=df_pred.to_csv(),
            file_name=f"UK_Grid_Forecast_{start_d}.csv",
            mime="text/csv"
        )
    else:
        st.error("‚ö†Ô∏è Please select a valid range (start and end date) on the calendar.")

st.divider()
st.caption("¬© 2026 Energy Analytics Portfolio | Kamil Kehinde | Data Source: NESO Data Portal")