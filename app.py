# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1YshZ0vTLJq1lwolpQ2IM26F1TUqQ607-
"""

import streamlit as st
import pandas as pd
import joblib
import datetime
import numpy as np
from PIL import Image

# 1. Page Config
st.set_page_config(
    page_title="UK Grid Analytics | Kamil Kehinde",
    page_icon="‚ö°",
    layout="wide"
)

# --- CUSTOM CSS FOR CENTERING ---
st.markdown("""
    <style>
    .centered-container {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        margin-bottom: 20px;
    }
    .metric-card {
        background-color: #ffffff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        border: 1px solid #eee;
    }
    </style>
    """, unsafe_allow_html=True)

# 2. Sidebar with Centered Image
with st.sidebar:
    st.markdown('<div class="centered-container">', unsafe_allow_html=True)
    try:
        # NOTE: Ensure the file name matches exactly
        profile_img = Image.open("kamil_profile.jpeg")
        st.image(profile_img, width=180)
    except:
        st.warning("‚ö†Ô∏è Image 'kamil_profile.jpeg' not found.")
    st.markdown(f"### Kamil Kehinde")
    st.markdown("Lead Energy Modeller")
    st.markdown('</div>', unsafe_allow_html=True)

    st.divider()
    st.info("Univariate XGBoost Forecast Engine v2.5")

# 3. Model Loading
@st.cache_resource
def load_model():
    return joblib.load('gb_gen_time_only.pkl')

model = load_model()

# 4. Main UI
st.title("‚ö° UK Electricity Generation Dashboard")
st.markdown("### Interactive Multi-Day Forecast & Grid Analytics")

# 5. Date Range Selection
st.divider()
col_cal, col_info = st.columns([1, 1])

with col_cal:
    # Set default range for Feb 2026
    start_default = datetime.date(2026, 2, 15)
    end_default = start_default + datetime.timedelta(days=3)

    selected_range = st.date_input(
        "üìÖ Select Forecast Horizon",
        value=(start_default, end_default),
        help="Select a range to see daily trends and total volume."
    )

# 6. Prediction & Visuals
if len(selected_range) == 2:
    start_date, end_date = selected_range

    # Generate 30-min intervals
    predict_index = pd.date_range(
        start=datetime.datetime.combine(start_date, datetime.time(0, 0)),
        end=datetime.datetime.combine(end_date, datetime.time(23, 30)),
        freq='30T'
    )

    # Feature engineering
    predict_df = pd.DataFrame(index=predict_index)
    predict_df['hour'] = predict_df.index.hour
    predict_df['dayofweek'] = predict_df.index.dayofweek
    predict_df['month'] = predict_df.index.month
    predict_df['year'] = predict_df.index.year

    # Run Forecast
    predict_df['Forecast_MW'] = model.predict(predict_df)

    # Calculations
    avg_mw = predict_df['Forecast_MW'].mean()
    total_gwh = (predict_df['Forecast_MW'].sum() * 0.5) / 1000
    peak_mw = predict_df['Forecast_MW'].max()

    # KPI Display
    k1, k2, k3 = st.columns(3)
    k1.metric("Average Load", f"{avg_mw:,.0f} MW")
    k2.metric("Total Energy Volume", f"{total_gwh:,.2f} GWh")
    k3.metric("Predicted Peak", f"{peak_mw:,.0f} MW")

    # Plotting
    st.markdown(f"#### üìà Generation Trend: {start_date} to {end_date}")
    st.line_chart(predict_df['Forecast_MW'], color="#FF4B4B")

    # Download
    st.download_button(
        "üì• Download Forecast (CSV)",
        data=predict_df.to_csv(),
        file_name=f"UK_Forecast_{start_date}.csv"
    )
else:
    st.info("Select a start and end date on the calendar above.")