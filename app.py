# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/19G_xR-Kvz8hHcMeFwQv4FuTn9wjlQKGC
"""

import streamlit as st
import pandas as pd
import joblib
import datetime
import numpy as np
import matplotlib.pyplot as plt
import os
from PIL import Image
from tensorflow.keras.models import load_model

# 1. Page Configuration
st.set_page_config(
    page_title="UK Grid Analytics | Kamil Kehinde",
    page_icon="‚ö°",
    layout="wide"
)

# --- üé® ADVANCED CUSTOM CSS ---
st.markdown("""
    <style>
    .stApp { background-color: #e6f3ff; }
    .main-img-container {
        display: flex;
        justify-content: center;
        margin-top: 10px;
        margin-bottom: 5px;
    }
    [data-testid="stMetricValue"] {
        font-size: 32px;
        color: #004080;
        font-weight: bold;
    }
    .justified-text { text-align: justify; }
    </style>
    """, unsafe_allow_html=True)

# 2. Sidebar - Branding & Identification
with st.sidebar:
    st.header("üë§ Lead Modeller")
    st.write("**Kamil Kehinde**")
    st.divider()
    st.info("üí° **Project Goal:** A.I. Forecasting-Modelling with Great Britain‚Äôs System Operator (NESO) Generation Data Portal.")
    st.caption("Developed as part of a high-resolution Energy Case Study.")

# 3. Central Image & Header
st.markdown('<div class="main-img-container">', unsafe_allow_html=True)
try:
    img = Image.open("kamil_profile.jpg")
    st.image(img, width=350, caption="Kamil Kehinde - Lead Modeller")
except:
    st.warning("‚ö†Ô∏è Image 'kamil_profile.jpg' not found in repository.")
st.markdown('</div>', unsafe_allow_html=True)

st.title("‚ö° UK Electricity Generation Dashboard")

# 4. Model & Scaler Loading
@st.cache_resource
def load_assets():
    base_path = os.path.dirname(__file__) if "__file__" in locals() else os.getcwd()
    model = load_model(os.path.join(base_path, 'uni_lstm_model.h5'))
    scaler = joblib.load(os.path.join(base_path, 'uni_scaler.pkl'))
    return model, scaler

# üîç LOAD SEED DATA (To avoid the straight line)
@st.cache_data
def load_seed_data():
    url = "https://raw.githubusercontent.com/kamilkenny/Deployment-of-UK-Electricity-Generation-Forecasting-/main/load_hindcast_data.csv"
    try:
        df_h = pd.read_csv(url)
        df_h['DATETIME'] = pd.to_datetime(df_h['DATETIME'])
        return df_h.sort_values('DATETIME')
    except:
        return pd.DataFrame()

try:
    model, scaler = load_assets()
    df_history = load_seed_data()
except Exception as e:
    st.error(f"Error loading assets: {e}")

# 5. User Input Configuration
st.divider()
st.subheader("üìÖ Configure Prediction Horizon")

col_input, _ = st.columns([1, 1])
with col_input:
    start_init = datetime.date(2026, 2, 17)
    end_init = start_init + datetime.timedelta(days=3)
    selected_range = st.date_input("Select Prediction Range", value=(start_init, end_init))

predict_btn = st.button("üöÄ Run LSTM Forecast Analysis", type="primary", use_container_width=True)

# 6. Forecast Execution Logic (RECURSIVE TREND FIX)
if predict_btn:
    if isinstance(selected_range, tuple) and len(selected_range) == 2:
        start_d, end_d = selected_range
        idx = pd.date_range(
            start=datetime.datetime.combine(start_d, datetime.time(0, 0)),
            end=datetime.datetime.combine(end_d, datetime.time(23, 30)),
            freq='30min'
        )

        # --- RECURSIVE FORECASTING LOOP ---
        # We start with the last 24 values from your CSV to 'prime' the model
        seed_values = df_history['GENERATION'].values[-24:].reshape(-1, 1)
        current_batch = scaler.transform(seed_values).reshape(1, 24, 1)

        forecast_scaled = []
        for i in range(len(idx)):
            # Predict next step
            pred = model.predict(current_batch, verbose=0)
            forecast_scaled.append(pred[0, 0])

            # Update the lookback window: Remove oldest, add newest prediction
            pred_reshaped = pred.reshape(1, 1, 1)
            current_batch = np.append(current_batch[:, 1:, :], pred_reshaped, axis=1)

        # Inverse scale to get MW
        mw_preds = scaler.inverse_transform(np.array(forecast_scaled).reshape(-1, 1))
        df_pred = pd.DataFrame({'Forecast_MW': mw_preds.flatten()}, index=idx)

        # Display KPIs
        st.divider()
        k1, k2, k3 = st.columns(3)
        k1.metric("Average Load", f"{df_pred['Forecast_MW'].mean():,.0f} MW")
        k2.metric("Predicted Peak", f"{df_pred['Forecast_MW'].max():,.0f} MW")
        k3.metric("Total Volume", f"{(df_pred['Forecast_MW'].sum()*0.5)/1000:,.2f} GWh")

        # Plot Trend (No more straight lines!)
        st.divider()
        st.markdown(f"#### üìä Generation Trend: {start_d} to {end_d}")
        st.line_chart(df_pred['Forecast_MW'], color="#007acc")

        st.download_button("üì• Download CSV", df_pred.to_csv(), "forecast.csv", "text/csv")