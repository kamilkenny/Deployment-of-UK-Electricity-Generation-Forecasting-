# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/19G_xR-Kvz8hHcMeFwQv4FuTn9wjlQKGC
"""

# -*- coding: utf-8 -*-
import streamlit as st
import pandas as pd
import joblib
import datetime
import numpy as np
import matplotlib.pyplot as plt
import os
import base64
from PIL import Image
from tensorflow.keras.models import load_model

# 1. Page Configuration
st.set_page_config(
    page_title="UK Grid Analytics | Kamil Kehinde",
    page_icon="‚ö°",
    layout="wide"
)

# --- üé® ADVANCED CUSTOM CSS ---
st.markdown("""
    <style>
    /* Light Blue Background */
    .stApp {
        background-color: #e6f3ff;
    }

    /* Force all text to Black for maximum sharpness */
    .stApp, p, span, label, .justified-text {
        color: #000000 !important;
    }

    /* Target headers explicitly */
    h1, h2, h3, h4, h5, h6 {
        color: #000000 !important;
    }

    /* Sidebar text color to Black */
    [data-testid="stSidebar"] .st-emotion-cache-17fal0n,
    [data-testid="stSidebar"] p,
    [data-testid="stSidebar"] span {
        color: #000000 !important;
    }

    /* Centering the Lead Modeller Architecture Image */
    .main-img-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 10px;
        margin-bottom: 20px;
        flex-direction: column;
        width: 100%;
    }

    /* Scale the image to be much larger on the screen */
    .responsive-img {
        width: 85%;
        max-width: 1100px;
        height: auto;
        border-radius: 10px;
        box-shadow: 0px 6px 15px rgba(0,0,0,0.15);
    }

    /* Styling Metric Cards - Value in Blue, Label in Black */
    [data-testid="stMetricValue"] {
        font-size: 32px;
        color: #004080 !important;
        font-weight: bold;
    }

    [data-testid="stMetricLabel"] p {
        color: #000000 !important;
    }

    /* Justified Text for Introduction */
    .justified-text {
        text-align: justify;
    }
    </style>
    """, unsafe_allow_html=True)

# 2. Sidebar - Branding & Identification
with st.sidebar:
    st.header("üë§ Lead Modeller")
    st.write("**Kamil Kehinde**")
    st.divider()
    st.info("üí° **Project Goal:** A.I. Forecasting-Model for Great Britain‚Äôs System Operator Generation Mix.")
    st.caption("Developed as part of a high-resolution Energy Case Study.")

# 3. Central Image & Header (TEXT REMOVED)
def get_image_base64(path):
    with open(path, "rb") as f:
        data = f.read()
    return base64.b64encode(data).decode()

try:
    img_b64 = get_image_base64("kamil_profile.png")
    st.markdown(
        f"""
        <div class="main-img-container">
            <img src="data:image/png;base64,{img_b64}" class="responsive-img">
            <p style="margin-top: 15px; font-size: 1.1em; font-weight: bold; color: black;">
                Kamil Kehinde - Lead Modeller
            </p>
        </div>
        """,
        unsafe_allow_html=True
    )
except Exception:
    st.warning("‚ö†Ô∏è Image 'kamil_profile.png' not found in repository.")

# Main Title & Executive Summary
st.title("‚ö° UK Electricity Generation Dashboard")
st.markdown("""
<div class="justified-text">
The UK electricity supply mix comprising of (Gas, Coal, Nuclear, Wind, Solar, Hydro, Biomass and Import). The system has undergone a significant transformation due to increasing <b>renewable penetration</b>,
declining <b>coal usage</b>, and evolving <b>demand patterns</b>. Accurate short-term electricity generation
forecasting is critical for:
</div>
""", unsafe_allow_html=True)

# Organizing pillars
c1, col_gap, c2, col_gap2, c3 = st.columns([1, 0.1, 1, 0.1, 1])
with c1:
    st.markdown("üéØ **Grid Balancing**")
    st.caption("Ensuring supply matches demand in real-time.")
with c2:
    st.markdown("üå± **Renewable Integration**")
    st.caption("Optimizing the use of intermittent sources like wind and solar.")
with c3:
    st.markdown("üìâ **Cost Reduction**")
    st.caption("Reducing the need for expensive, high-carbon reserve power plants.")

# 4. Model & Assets Loading
@st.cache_resource
def load_assets():
    base_path = os.path.dirname(__file__) if "__file__" in locals() else os.getcwd()
    model_path = os.path.join(base_path, 'uni_lstm_model.h5')
    scaler_path = os.path.join(base_path, 'uni_scaler.pkl')

    nn_model = load_model(model_path)
    scaler = joblib.load(scaler_path)
    return nn_model, scaler

@st.cache_data
def load_seed_data():
    url = "https://raw.githubusercontent.com/kamilkenny/Deployment-of-UK-Electricity-Generation-Forecasting-/main/load_hindcast_data.csv"
    try:
        df_h = pd.read_csv(url)
        df_h['DATETIME'] = pd.to_datetime(df_h['DATETIME'])
        return df_h.sort_values('DATETIME')
    except:
        return pd.DataFrame()

try:
    model, scaler = load_assets()
    df_history = load_seed_data()
except Exception as e:
    st.error(f"üö® System Error: {e}")

# 5. User Input Configuration
st.divider()
st.subheader("üìÖ Configure Prediction Horizon")

col_input, _ = st.columns([1, 1])
with col_input:
    # Set to current year context
    start_init = datetime.date(2026, 2, 17)
    end_init = start_init + datetime.timedelta(days=3)
    selected_range = st.date_input("Select Prediction Range", value=(start_init, end_init))

predict_btn = st.button("üöÄ Run Generation Forecast Analysis", type="primary", use_container_width=True)

# 6. Recursive Forecast Logic
if predict_btn:
    if isinstance(selected_range, tuple) and len(selected_range) == 2:
        start_d, end_d = selected_range
        idx = pd.date_range(
            start=datetime.datetime.combine(start_d, datetime.time(0, 0)),
            end=datetime.datetime.combine(end_d, datetime.time(23, 30)),
            freq='30min'
        )

        if not df_history.empty:
            seed_values = df_history['GENERATION'].values[-24:].reshape(-1, 1)
            current_batch = scaler.transform(seed_values).reshape(1, 24, 1)
        else:
            current_batch = np.full((1, 24, 1), 0.5)

        forecast_scaled = []
        progress_bar = st.progress(0)
        for i in range(len(idx)):
            pred = model.predict(current_batch, verbose=0)
            forecast_scaled.append(pred[0, 0])
            pred_reshaped = pred.reshape(1, 1, 1)
            current_batch = np.append(current_batch[:, 1:, :], pred_reshaped, axis=1)
            progress_bar.progress((i + 1) / len(idx))

        mw_preds = scaler.inverse_transform(np.array(forecast_scaled).reshape(-1, 1))
        df_pred = pd.DataFrame({'Forecast_MW': mw_preds.flatten()}, index=idx)

        st.divider()
        st.markdown("#### üìà Key Performance Indicators (KPIs)")
        k1, k2, k3 = st.columns(3)
        k1.metric("Average Load", f"{df_pred['Forecast_MW'].mean():,.0f} MW")
        k2.metric("Predicted Peak", f"{df_pred['Forecast_MW'].max():,.0f} MW")
        k3.metric("Total Volume", f"{(df_pred['Forecast_MW'].sum() * 0.5) / 1000:,.2f} GWh")

        st.divider()
        st.markdown(f"#### üìä Generation Trend: {start_d} to {end_d}")
        st.line_chart(df_pred['Forecast_MW'], color="#004080")

        st.download_button("üì• Download Analysis Results (CSV)", df_pred.to_csv(), "forecast_results.csv", "text/csv")
    else:
        st.error("‚ö†Ô∏è Please select a valid start and end date.")

st.divider()
st.caption("¬© 2026 Energy Analytics Portfolio | Kamil Kehinde | Data Source: NESO Data Portal")