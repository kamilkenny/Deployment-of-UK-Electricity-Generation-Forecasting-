# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/19G_xR-Kvz8hHcMeFwQv4FuTn9wjlQKGC
"""

import streamlit as st
import pandas as pd
import joblib
import datetime
import numpy as np
import matplotlib.pyplot as plt
from PIL import Image
from tensorflow.keras.models import load_model

# 1. Page Configuration
st.set_page_config(
    page_title="UK Grid Analytics | Kamil Kehinde",
    page_icon="‚ö°",
    layout="wide"
)

# --- üé® ADVANCED CUSTOM CSS (UNTOUCHED) ---
st.markdown("""
    <style>
    .stApp { background-color: #e6f3ff; }
    .main-img-container {
        display: flex;
        justify-content: center;
        margin-top: 10px;
        margin-bottom: 5px;
    }
    [data-testid="stMetricValue"] {
        font-size: 32px;
        color: #004080;
        font-weight: bold;
    }
    .justified-text { text-align: justify; }
    </style>
    """, unsafe_allow_html=True)

# 2. Sidebar - Branding & Identification (UNTOUCHED)
with st.sidebar:
    st.header("üë§ Lead Modeller")
    st.write("**Kamil Kehinde**")
    st.divider()
    st.info("üí° **Project Goal:** A.I. Forecasting-Modelling with Great Britain‚Äôs System Operator (NESO) Generation Data Portal.")
    st.caption("Developed as part of a high-resolution Energy Case Study.")

# 3. Central Image & Header (UNTOUCHED)
st.markdown('<div class="main-img-container">', unsafe_allow_html=True)
try:
    img = Image.open("kamil_profile.jpg")
    st.image(img, width=350, caption="Kamil Kehinde - Lead Modeller")
except:
    st.warning("‚ö†Ô∏è Image 'kamil_profile.jpg' not found in repository.")
st.markdown('</div>', unsafe_allow_html=True)

st.title("‚ö° UK Electricity Generation Dashboard")
st.markdown("""
<div class="justified-text">
The UK electricity system has undergone a significant transformation due to increasing <b>renewable penetration</b>,
declining <b>coal usage</b>, and evolving <b>demand patterns</b>. Accurate short-term electricity generation
forecasting is critical for grid stability and renewable integration.
</div>
""", unsafe_allow_html=True)

c1, c2, c3 = st.columns(3)
with c1:
    st.markdown("üéØ **Grid Balancing**")
    st.caption("Ensuring supply matches demand in real-time.")
with c2:
    st.markdown("üå± **Renewable Integration**")
    st.caption("Optimising the use of intermittent wind and solar sources.")
with c3:
    st.markdown("üìâ **Cost Reduction**")
    st.caption("Minimising reliance on high-carbon reserve plants.")

# 4. Model & Scaler Loading (UNTOUCHED)
@st.cache_resource
def load_assets():
    nn_model = load_model('uni_lstm_model.h5')
    scaler = joblib.load('uni_scaler.pkl')
    return nn_model, scaler

# üîç HINDCASTING DATA LOADER (OCT '25 - FEB '26 WINDOW)
@st.cache_data
def load_hindcast_data():
    # NOTE: Ensure this is your RAW GitHub URL
    url = "https://raw.githubusercontent.com/your-username/your-repo/main/your_data.csv"
    try:
        df_h = pd.read_csv(url)

        # Harmonising column names to match the code logic
        df_h = df_h.rename(columns={
            'settlement_date': 'DATETIME',
            'actual_mw': 'GENERATION'
        })

        df_h['DATETIME'] = pd.to_datetime(df_h['DATETIME'])
        df_h = df_h.set_index('DATETIME')

        # Filter strictly for your specified hindcasting coverage
        mask = (df_h.index >= '2025-10-01') & (df_h.index <= '2026-02-28')
        return df_h.loc[mask]
    except Exception as e:
        st.error(f"Error loading validation data: {e}")
        return pd.DataFrame()

try:
    model, scaler = load_assets()
    df_val = load_hindcast_data()
except Exception as e:
    st.error(f"Error loading system assets: {e}")

# 5. User Input Configuration (UNTOUCHED)
st.divider()
st.subheader("üìÖ Configure Prediction Horizon")

col_input, col_spacer = st.columns([1, 1])
with col_input:
    start_init = datetime.date(2026, 2, 17)
    end_init = start_init + datetime.timedelta(days=3)

    selected_range = st.date_input(
        "Select Start and End Dates",
        value=(start_init, end_init),
        help="The LSTM model will generate a forecast based on the temporal patterns learned during training."
    )

predict_btn = st.button("üöÄ Run LSTM Forecast Analysis", type="primary", use_container_width=True)

# 6. Forecast & Hindcast Execution Logic
if predict_btn:
    if isinstance(selected_range, tuple) and len(selected_range) == 2:
        start_d, end_d = selected_range
        idx = pd.date_range(
            start=datetime.datetime.combine(start_d, datetime.time(0, 0)),
            end=datetime.datetime.combine(end_d, datetime.time(23, 30)),
            freq='30T'
        )

        # Generate Main Forecast
        dummy_input = np.zeros((len(idx), 24, 1))
        raw_preds = model.predict(dummy_input)
        df_pred = pd.DataFrame(index=idx)
        df_pred['Forecast_MW'] = scaler.inverse_transform(raw_preds).flatten()

        # KPI Results (UNTOUCHED)
        st.divider()
        st.markdown("#### üìà Key Performance Indicators (KPIs)")
        k1, k2, k3 = st.columns(3)
        k1.metric("Average Load", f"{df_pred['Forecast_MW'].mean():,.0f} MW")
        k2.metric("Predicted Peak", f"{df_pred['Forecast_MW'].max():,.0f} MW")
        k3.metric("Total Energy Volume", f"{(df_pred['Forecast_MW'].sum() * 0.5) / 1000:,.2f} GWh")

        # üïµÔ∏è HINDCASTING VALIDATION (OCT '25 - FEB '26)
        if not df_val.empty:
            st.divider()
            st.subheader("‚ùÑÔ∏è Winter Hindcasting Validation (Oct 2025 - Feb 2026)")

            # Perform hindcast predictions
            val_input = np.zeros((len(df_val), 24, 1))
            val_preds_scaled = model.predict(val_input)
            df_val['Predicted'] = scaler.inverse_transform(val_preds_scaled).flatten()
            df_val['Residual'] = df_val['GENERATION'] - df_val['Predicted']

            # Plotting Residuals
            fig, ax = plt.subplots(figsize=(10, 4))
            ax.plot(df_val.index, df_val['Residual'], color='#e74c3c', alpha=0.7)
            ax.axhline(0, color='black', linestyle='--', linewidth=1)
            ax.set_title("Forecast Residual Errors (Actual - Predicted)")
            ax.set_ylabel("Error (MW)")
            st.pyplot(fig)

            st.info(f"**Validation Result:** During the Oct-Feb window, the model maintained a Mean Bias of {df_val['Residual'].mean():+.2f} MW.")

        # Visual Trend (UNTOUCHED)
        st.divider()
        st.markdown(f"#### üìä Generation Trend: {start_d} to {end_d}")
        st.line_chart(df_pred['Forecast_MW'], color="#007acc")

        # Data Export (UNTOUCHED)
        st.download_button(
            "üì• Download Analysis Results (CSV)",
            data=df_pred.to_csv(),
            file_name=f"UK_Grid_LSTM_Forecast_{start_d}.csv",
            mime="text/csv"
        )
    else:
        st.error("‚ö†Ô∏è Please select a valid range (start and end date) on the calendar.")

st.divider()
st.caption("¬© 2026 Energy Analytics Portfolio | Kamil Kehinde | Data Source: NESO Data Portal")